# Debugging Unparsed Messages Feature

## Issue: "Unexpected error occurred" when parsing fails

This means the backend is throwing an exception when trying to save the unparsed message.

## âœ… Changes Made to Help Debug

### 1. Enhanced Error Logging
- **GlobalExceptionHandler.java**: Now prints the full stack trace and actual error message
- **TransactionService.java**: Added try-catch with detailed logging around unparsed message saving
- **UnparsedMessageService.java**: Added logging for save operations

### 2. Safe Failure Handling
- If unparsed message saving fails, it won't crash the entire request
- You'll still get the "Unable to parse SMS" error
- The unparsed message just won't be saved (but logged in console)

## ğŸ”§ Steps to Fix

### Step 1: Restart Backend with Clean Slate

```bash
cd backend

# Stop any running backend (Ctrl+C if running in terminal)

# Clean and rebuild
./mvnw clean install

# Start the backend
./mvnw spring-boot:run
```

**Watch the console output for:**
- âœ… "Hibernate: create table unparsed_messages" - Table created successfully
- âœ… "Started PiggyApplication" - Backend started
- âŒ Any errors about table creation or schema

### Step 2: Check Database Tables

The backend should automatically create the `unparsed_messages` table. You should see SQL output in the console like:

```sql
Hibernate: create table unparsed_messages (
    id bigint generated by default as identity,
    bank_address varchar(255),
    created_at timestamp(6),
    error_message varchar(1000),
    processed boolean default false,
    sms_message varchar(2000),
    user_id bigint not null,
    primary key (id)
)
```

### Step 3: Test with Logging

1. **Open backend console/terminal** (where you ran `./mvnw spring-boot:run`)
2. **Go to Dashboard** in browser
3. **Try to parse a message that will fail:**
   - Bank Address: `TESTBANK`
   - Message: `Your account debited Rs 500 on 28-Jan-26`
4. **Click "Parse SMS"**

**Expected Console Output:**

#### If Working Correctly:
```
Saving unparsed message for bank: TESTBANK
âœ“ Unparsed message saved with ID: 1
âœ“ Unparsed message saved successfully for user: yourUsername
```

#### If There's a Problem:
```
Unexpected error occurred:
[Stack trace will show the actual error]
âš  Failed to save unparsed message: [error details]
```

### Step 4: Check for Common Issues

#### Issue A: Table Not Created
**Symptoms:** Error like "Table 'unparsed_messages' doesn't exist"

**Fix:**
```bash
# In application.properties, ensure:
spring.jpa.hibernate.ddl-auto=update
# or
spring.jpa.hibernate.ddl-auto=create-drop
```

#### Issue B: User Entity Not Found
**Symptoms:** Error like "user_id cannot be null" or "user not found"

**Fix:** Make sure you're logged in with a valid user account

#### Issue C: Circular Dependency
**Symptoms:** Error about circular bean dependency

**Fix:** The UnparsedMessageService is properly @Autowired (should be fine)

#### Issue D: Database Connection
**Symptoms:** "Unable to acquire JDBC Connection"

**Fix:** Check your database connection settings in `application.properties`

## ğŸ§ª Testing Guide

### Test 1: Single SMS Parse Failure

1. **Dashboard â†’ Single SMS**
2. **Enter:**
   - Bank Address: `TESTBANK`
   - SMS: `Any random text here`
3. **Click Parse**
4. **Expected:**
   - Frontend: Error toast with "Unable to parse SMS message. No matching pattern found..."
   - Backend console: "âœ“ Unparsed message saved with ID: X"
   - SMS Parser: "Pending Messages (1)" button appears

### Test 2: Bulk Upload Failures

1. **Dashboard â†’ Bulk Upload**
2. **Upload:** `test-unparsed.json`
3. **Expected:**
   - Frontend: "3 message(s) failed to parse"
   - Backend console: 3 save success messages
   - SMS Parser: "Pending Messages (3)" button

### Test 3: View and Use Pending Message

1. **Go to SMS Parser**
2. **Click "Pending Messages"** button
3. **Should see:** Modal with list of failed messages
4. **Click "Use This"** on any message
5. **Expected:** Form auto-fills, message marked as processed

## ğŸ“Š Verify Database Directly

If you're using H2 database (default), you can access the H2 Console:

1. **Open:** http://localhost:8080/h2-console
2. **JDBC URL:** jdbc:h2:mem:testdb (or check your application.properties)
3. **Username:** sa
4. **Password:** (leave empty or check application.properties)
5. **Connect**
6. **Run query:**
   ```sql
   SELECT * FROM unparsed_messages;
   ```

You should see your unparsed messages stored there.

## ğŸ› Still Having Issues?

### Check Backend Console for These Patterns:

#### Pattern 1: Service is Null
```
âš  UnparsedMessageService is null - cannot save unparsed message
```
**Fix:** Check @Autowired annotation and Spring configuration

#### Pattern 2: Database Error
```
âœ— Error saving unparsed message: could not execute statement
```
**Fix:** Check database connection and table creation

#### Pattern 3: Generic Exception
```
Unexpected error occurred:
java.lang.NullPointerException
  at com.piggy.backend.service...
```
**Fix:** Read the stack trace to find the specific line causing the issue

## ğŸ“ Additional Debugging Commands

### Check if tables exist (H2 Console):
```sql
SHOW TABLES;
```

### Check unparsed_messages structure:
```sql
SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'UNPARSED_MESSAGES';
```

### Count unparsed messages:
```sql
SELECT COUNT(*) FROM unparsed_messages;
```

### View all unparsed messages:
```sql
SELECT id, bank_address, processed, created_at, 
       SUBSTRING(sms_message, 1, 50) as sms_preview
FROM unparsed_messages
ORDER BY created_at DESC;
```

## ğŸ¯ Success Checklist

- [ ] Backend starts without errors
- [ ] `unparsed_messages` table created in database
- [ ] Parse failure shows proper error message (not "unexpected error")
- [ ] Backend console shows "âœ“ Unparsed message saved successfully"
- [ ] SMS Parser shows "Pending Messages" button
- [ ] Can view pending messages in modal
- [ ] "Use This" button auto-fills the form
- [ ] Database contains the unparsed message records

## ğŸ’¡ Tips

1. **Always watch the backend console** - it has the most useful debugging info
2. **Restart backend after code changes** - especially entity/repository changes
3. **Check H2 Console** - verify data is actually being saved
4. **Use test-unparsed.json** - quick way to generate test data
5. **Clear browser cache** - if frontend seems stuck

## ğŸ†˜ Last Resort

If nothing works:

1. Stop backend
2. Delete any persistent database files (if not using in-memory H2)
3. Run `./mvnw clean`
4. Delete `target` folder
5. Run `./mvnw spring-boot:run`
6. Fresh start should create all tables from scratch
